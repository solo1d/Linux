# Linux 账号管理与 ACL 权限设置

- 在登录界面输入帐号密码后,系统所处理的内容:

  - 先找寻`/etc/passwd`里面是否有你输入的帐号,如果没有则跳出，如果有的话则将该帐号 对应的 UID 与 GID (在 `/etc/group` 中) 读出来，另外，该帐号的主文件夹与 shell 设置 也一并读出; 

  - 再来则是核对密码表啦!这时Linux会进入`/etc/shadow`里面找出对应的帐号与UID，然 

    后核对一下你刚刚输入的密码与里头的密码是否相符? 

  - 如果一切都OK的话，就进入Shell控管的阶段

- 登陆你的 Linux 主机的时候，那个` /etc/passwd` 与` /etc/shadow` 就必须要让系统读取.

## 使用者账号

#### /etc/passwd 文件结构

 程序的运行都和权限有关, 而权限与 UID/GID 有关, 因此各程序需要读取 /etc/passwd 来了解不同账号的权限.

```bash
/etc/passwd:
root:  x:  0:  0:  root:  /root:  /bin/bash

#一共七个字段, 挨个说明:
1. root : 帐号名称, 它对应于 UID
2. x    : 早期 UNIX 系统的密码段, 但是目前内容已经移动到 /etc/shadow 中, 这里只是占位符
3. 0    : UID ,使用者识别码,  0是管理员, 1~999 是系统账号(不可登录), 1000~60000 为可登入账号
4. 0    : GID , 这个于 /etc/group 有关. (组群名称 于 GID 的对应)
5. root : 使用者信息说明栏,没什么用. ( $chfn 指令可以来解释这字段)
6. /root: 主文件夹,使用者登入后 就会立即进入到 该目录下.(可修改)
7./bin/bash : 这个是 登入后默认使用的 Shell . (如果是 /sbin/nologin 则代表不可登录)
```

#### /etc/shadow  文件结构 

shadow 文件是用来保存密码和一些密码相关设置的.

- root 密码遗忘的解决方法, (都必须操作主机,而不是网络操作)
  - 进入单人维护模式, 系统会自动的给予 root 权限的bash 接口,在以 passwd 修改密码即可
  - 或者以 Live CD 开机,挂载根目录 去修改 /etc/shadow ,将里面的 root 的密码字段情况,再次开机之后, root 将不用密码即可登录.

查看目前 shadow 使用的哪种账号密码机制 命令:  **`$ authconfig --test | grep hashing `**

```bash
root: $6$AcvdhTi9i0:  : 0: 99999: 7:  :  :
dmtsai:$6$IyhtHAG6B:  : 0: 99999: 7:  :  :
1   : 2            :3 :4 :   5  : 6: 7: 8: 9
#一共9个字段
1. 账号名称, 必须和 /etc/passwd 相同
2. 通过编码的密码,在这个字段加入 ! 或 * 可以使密码失效,无法验证,也就表示无法登录.
3. 最近更改密码那一天 距离 1970年1月1日(作为1) 过去了多少天.没有修改过密码则为空.
4. 密码在最近一次被更改后还需要几天才可以在被改变,如果是0 则表示密码可以随时改动. 如果是20,则表示	   今天修改过密码后,那么20天之内都无法再次修改密码了.
5. 强制要求在多少天之内必须修改密码, 99999(273年) 则表示密码的变更没有强制之意.
6. 密码需要变更期限前的警告天数. 以上次修改密码的时间为基准.
7. 密码过期后的宽限日期(密码失效日).
8. 账户失效日期,也是距离 1970年的天数为单位,账户到达规定日期后,就无法登录和使用了(常用在收费服务)
9. 保留字段.暂时没有功能.
```



#### /etc/group  文件结构

**这个文件记录了  GID  与群组名称的对应关系**

```bash
root   :x : 0    :
dmtsai :x : 1000 : dmtsai,alex

#一共4个分段
1. 群组名称, 就是群组名,给人看的,需要与第三个字段 GID 对应
2. 群组密码, 通常不需要设置,这设置是给 "群组管理员"使用的, 需要与第三个字段 GID 对应,废弃字段.
3. GID , 就是群组 ID , /etc/passwd 第四个字段使用的GID对应的群组名就是由这里对应出来的.
4. 此群组支持的账号名称,也就是同组的用户, 用逗号分隔,不可以有空格.
```

#### 有效群组, 主要体现在创建文件时,文件的所属组

```bash
$groups          #该命令会得到当前用户的所属群组, 第一个就是有效群组.
$newgrp	 群组		  #有效群组的切换.只可以切换到该用户已经支持的群组.这个切换是进入了一个新的bash			             #需要使用 exit 来退出 切换的群组环境. 要不然会出现很多问题.
```



### /etc/gshadow    群组管理员

这个文件最大的功能就是 创建群组管理员.(将某个使用者加入到某些群组)

群组管理员可以通过  $gpasswd  命令. 来将某个账户添加到管理的组下.

```bash
root  :   : :
dmtsai: !!: :dmtsai

#4个分段,  和/etc/group 差不多
1. 群组名称
2. 密码栏, 如果为空 或 !则表示 无合法密码, 所以无群组管理员
3. 群组管理员的账号.( 在 /etc/gpasswd 文件中有记录 )
4. 在该群组的下的用户 ( 与 /etc/group 内容相同)
```



## 账号管理

### 新增与移除使用者:   useradd , 相关文件配置 和  passwd ,usermod, userdel

#####  useradd   创建使用者

由于系统帐号主要是用来进行运行系统所需服务的权限设置， 所以 系统帐号默认都不会主动创建主文件夹的 

useradd  这个命令在创建Linux账号时会参考下面几个文件的内容 : `/etc/default/useradd` , `/etc/login.defs ` , `/etc/skel/*`

```bash
$useradd  [-u UID]  [-g 初始化群组] [-G 次要群组]  [-mM] [-c 说明栏] [-d 主文件夹绝对路径] 	         [-s 默认shell ]  使用者账号名

选项和参数:
-u  :后面接的是 UID ，是一组数字。直接指定一个特定的 UID 给这个帐号;
-g  :后面接的那个群组名称就是初始化群组,默认创建文件或文件夹都是这个组名
	     该群组的 GID 会被放置到 /etc/passwd 的第四个字段内。
-G  :后面接的群组名称则是这个帐号还可以加入的群组。
       这个选项与参数会修改 /etc/group 内的相关数据
-M  :强制! 不要创建使用者主文件夹!(系统帐号默认值)
-m  :强制! 要创建使用者主文件夹!(一般帐号默认值)
-c  :这个就是 /etc/passwd 的第五栏的说明内容, 可以随便设置
-d  :指定某个目录成为主文件夹，而不要使用默认值。务必使用绝对路径!
-r  :创建一个系统的帐号，这个帐号的 UID 会有限制 (参考 /etc/login.defs)
-s  :后面接一个 shell ，若没有指定则默认是 /bin/bash 的啦~
-e  :后面接一个日期，格式为“YYYY-MM-DD”此项目可写入 shadow 第八字段,亦即帐号失效日的设置项目
-f  :后面接 shadow 的第七字段项目，指定密码是否会失效。
	     0为立刻失效，-1  为永远不失效(密码只会过期而强制于登陆时重新设置而已。), 1 为一天后失效.
-D  :显示 useradd  创建用户的默认参考值, 默认的群组,默认shell ,默认主文件夹内容,默认邮件信息..
				这些数据都存在于  /etc/default/useradd  和 /etc/login.defs 中

范例: 完全参考默认值创建一个使用者，名称为 vbird1
$useradd  vbird1    #执行完成后, 会在 /home 目录下出现 vbird1 文件夹. (MAC则是 /Users 下)

# 在默认情况下创建用户,系统会帮我们处理的几个项目.(都记录在 /etc/login.defs 文件内)
     #1. 在 /etc/passwd 里面创建一行与帐号相关的数据，包括创建 UID/GID/主文件夹等; 
     #2. 在 /etc/shadow 里面将此帐号的密码相关参数填入，但是尚未有密码;
     #3. 在 /etc/group 里面加入一个与帐号名称一模一样的群组名称;
	   #4 .在 /home 下面创建一个与帐号同名的目录作为使用者主文件夹，且权限为 700

范例二:假设我已知道我的系统当中有个群组名称为 users ，且 UID 1500 并不存在,
		  请用 users 为初始群组，以及 uid 为 1500 来创建一个名为 vbird2 的帐号
$useradd   -u 1500 -g users  vbird2


范例三:  创建系统账号,  名称为 vbird3
$useradd -r vbird3
```

### passwd  修改密码

```bash
$passwd  [--stdin] [账号名称]     #所有人均可使用来修改自己的密码
$passwd  [-l] [-u]  [--stdin]  [-S] [-n 天数] [-w 天数] [-i 日期] 账号  #root 可用
选项参数:
--stdin  :可以通过来自前一个管道的数据,作为密码输入,对 shell script脚本有帮助
-l       :是 lock 的意思, 会将 /etc/shadow 第二栏最前面加上 ! 使密码失效,从而无法登录.
-u	     :与 -l 作用相反, 会取消密码失效的状态.
-S	     :列出密码相关参数, 亦即 shadow 文件内的大部分信息
-n       :后面接天数, shadow 第4字段, 多久不可修改密码的天数.
-x			 :后面接天数, shadow 第5字段, 多久内必须更改密码的天数.
-w       :后面接天数, shadow 第6字段,  密码过期前的警告天数
-i       :后面接 "日期"  , shadow 第7字段,密码过期后的宽限天数.(这个天数与第5字段有很大关系)
					  也就是说 -i 2 -x 5  表示密码在5天内必须修改,如果不修改那么在7天后账户密码就过期了.

如果不加任何参数就直接执行 passwd  ,则会默认修改执行者本身的密码.


范例一:请 root 给予 vbird2 密码
$passwd  vbird2
输出:
Changing password for user vbird2.
New UNIX password:           #写入新密码
Retype new UNIX password:	   #再次输入新密码,是为了验证.


范例二: 使用管道来输入和设定 vbird2 的密码, 新密码是 newpasswd
$echo  "newpasswd" | passwd --stdin vbird2	      #这个内容常用在 脚本内

范例三: 让 vbird2 每60天需要更改一次密码, 密码过期后10天就宣告账号失效.
 $passwd -i 10 -x 60 vbird2
 
范例四:  让 vbird2 账户失效,无法登录.
$passwd  -l vbird2		 #这样就无法登录了, 只是在修改 /etc/passwd 文件的第二个字段

```



























